#!/usr/bin/env python3
import subprocess
from pathlib import Path
import re

HEADER_FILE = Path("EmdBoard.h")
DEFINE_RE = re.compile(r'^(#define\s+SW_BUILD_VERSION\s+)".*?"$', re.MULTILINE)

def get_git_short_hash():
    try:
        # Short commit hash only
        return subprocess.check_output(
            ["git", "rev-parse", "--short", "HEAD"], text=True
        ).strip()
    except subprocess.CalledProcessError:
        return "UNKNOWN"

def get_git_date():
    try:
        # Date in DD.MM.YYYY format
        return subprocess.check_output(
            ["git", "show", "-s", "--format=%cd", "--date=format:%d.%m.%Y", "HEAD"],
            text=True
        ).strip()
    except subprocess.CalledProcessError:
        return "01.01.1970"

def update_header_file(header_path, value):
    if header_path.exists():
        content = header_path.read_text()
        new_content, count = DEFINE_RE.subn(r'\1"' + value + '"', content)
        if count:
            header_path.write_text(new_content)
            return
    # If file doesn't exist or define not found, create it
    lines = [
        "// Auto-generated by script_sw_ver.py in the following format <gitcommit_version>.DD.MM.YYYY",
        f'#define SW_BUILD_VERSION "{value}"',
        "",
    ]
    header_path.write_text("\n".join(lines))

def main():
    commit = get_git_short_hash()
    date = get_git_date()
    version_str = f"{commit}.{date}"
    update_header_file(HEADER_FILE, version_str)
    print(f"Updated {HEADER_FILE} -> {version_str}")

if __name__ == "__main__":
    main()
